# 1. å¯¼å…¥å·¥å…·åŒ…
from flask import Flask, request, jsonify
import os
from dotenv import load_dotenv
import time  # ç”¨äºæ¨¡æ‹Ÿå»¶è¿Ÿï¼Œè®©å“åº”æ›´çœŸå®

# 2. åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆä»æœ¬åœ° .env æ–‡ä»¶è¯»å–å¯†é’¥ï¼‰
load_dotenv()

# 3. åˆ›å»ºFlaskåº”ç”¨
app = Flask(__name__)


# 4. å¥åº·æ£€æŸ¥æ¥å£ï¼ˆä¿æŒä¸å˜ï¼‰
@app.route('/health', methods=['GET'])
def health_check():
    return jsonify({"status": "ok", "message": "åç«¯æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ï¼"})

@app.route('/')
def home_page():
    return '''
    <h1>æˆ‘çš„AIç½‘ç«™åç«¯</h1>
    <p>âœ… æœåŠ¡æ­£åœ¨è¿è¡Œï¼</p>
    <p>å¯ç”¨æ¥å£ï¼š</p>
    <ul>
        <li><a href="/health">/health</a> - å¥åº·æ£€æŸ¥</li>
        <li>POST /chat - AIå¯¹è¯æ¥å£</li>
    </ul>
    '''

# 5. æ ¸å¿ƒå¯¹è¯æ¥å£ï¼ˆå·²ä¿®æ”¹ä¸ºæ¨¡æ‹Ÿå“åº”ï¼‰
@app.route('/chat', methods=['POST'])
def chat_with_ai():
    """æ¨¡æ‹ŸAIå“åº”ï¼Œä¿æŒæ¥å£æ ¼å¼ä¸å˜ï¼Œä¾›å‰ç«¯æ­£å¸¸è°ƒç”¨"""
    # 5.1 è·å–å‰ç«¯å‘æ¥çš„æ•°æ®
    data = request.json
    user_message = data.get('message', '')

    if not user_message:
        return jsonify({"error": "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º"}), 400

    try:
        # ============ ã€æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼šæ¨¡æ‹Ÿå“åº”å¼€å§‹ã€‘ ============
        print(f"[æ¨¡æ‹Ÿæ¨¡å¼] æ”¶åˆ°ç”¨æˆ·é—®é¢˜: {user_message[:50]}...")

        # æ¨¡æ‹Ÿä¸€ä¸ªâ€œæ€è€ƒâ€è¿‡ç¨‹ï¼Œè®©å“åº”æ›´çœŸå®ï¼ˆå¯é€‰ï¼‰
        time.sleep(0.3)

        # æ„å»ºä¸€ä¸ªæ ¼å¼æ­£ç¡®ã€æœ‰æ„ä¹‰çš„æ¨¡æ‹Ÿå›å¤
        ai_response = f"[æ¨¡æ‹Ÿå›å¤] æˆ‘å·²ç†è§£æ‚¨çš„é—®é¢˜ï¼š'{user_message}'ã€‚å½“å‰AIæœåŠ¡æ­£åœ¨å‡çº§é…ç½®ä¸­ï¼ŒçœŸå®åŠŸèƒ½å³å°†ä¸Šçº¿ã€‚"

        # ä½ ä¹Ÿå¯ä»¥è®©å›å¤æ›´æ™ºèƒ½ä¸€äº›ï¼Œä¾‹å¦‚ï¼š
        if 'ä½ å¥½' in user_message or 'hello' in user_message:
            ai_response = "[æ¨¡æ‹Ÿå›å¤] ä½ å¥½ï¼æˆ‘æ˜¯ç½‘ç«™çš„åç«¯AIåŠ©æ‰‹ï¼Œç›®å‰å¤„äºæ¼”ç¤ºæ¨¡å¼ã€‚"
        elif 'å¤©æ°”' in user_message:
            ai_response = "[æ¨¡æ‹Ÿå›å¤] è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºã€‚æ¥å…¥çœŸå®å¤©æ°”APIåï¼Œè¿™é‡Œå°†è¿”å›çœŸå®çš„å¤©æ°”ä¿¡æ¯ã€‚"
        # ============ ã€æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼šæ¨¡æ‹Ÿå“åº”ç»“æŸã€‘ ============

        # 5.2 è¿”å›æ ‡å‡†æ ¼å¼çš„å“åº”ï¼ˆå‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹ï¼‰
        return jsonify({"reply": ai_response})

    except Exception as e:
        # å¦‚æœå‘ç”Ÿæ„å¤–é”™è¯¯
        print(f"[é”™è¯¯] {str(e)}")
        return jsonify({"error": f"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {str(e)}"}), 500

if __name__ == '__main__':
    # ä»ç¯å¢ƒå˜é‡è·å–ç«¯å£ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼ˆå¦‚åœ¨æœ¬åœ°è¿è¡Œï¼‰åˆ™é»˜è®¤ä¸º5000
    port = int(os.environ.get('PORT', 5000))
    print(f"âœ… åç«¯æœåŠ¡å™¨æ­£åœ¨å¯åŠ¨...")
    print(f"ğŸŒ æœ¬åœ°æµ‹è¯•åœ°å€: http://127.0.0.1:{port}")
    app.run(debug=True, host='0.0.0.0', port=port)
